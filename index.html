<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OsteoCoach v5.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg-dark: #0a0a0b; --card-bg: #161618; --accent: #3b82f6; --text-main: #f8fafc; --text-muted: #94a3b8; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        .card { background-color: var(--card-bg); border-radius: 16px; padding: 20px; border: 1px solid #27272a; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4); }
        .btn { padding: 14px 20px; border-radius: 12px; font-weight: 700; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .btn-secondary { background: #27272a; color: white; border: 1px solid #3f3f46; }
        .input-dark { background: #000; border: 1px solid #27272a; color: white; padding: 12px; border-radius: 10px; width: 100%; text-align: center; font-size: 16px; outline: none; transition: border-color 0.2s; }
        .input-dark:focus { border-color: var(--accent); }

        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        .pulse-ring { animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }

        .nav-bar { position: fixed; bottom: 0; width: 100%; background: rgba(10, 10, 11, 0.9); backdrop-filter: blur(12px); border-top: 1px solid #27272a; padding: 12px 20px; display: flex; justify-content: space-around; z-index: 50; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        .nav-item { color: var(--text-muted); display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; transition: color 0.2s; }
        .nav-item.active { color: var(--accent); }

        .timer-circle { width: 140px; height: 140px; border-radius: 50%; border: 4px solid #27272a; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: 800; margin: 0 auto; position: relative; color: var(--accent); }
    </style>
</head>
<body class="pb-24">

    <!-- HEADER -->
    <div class="fixed top-0 w-full bg-black/80 backdrop-blur-md border-b border-zinc-800 z-50 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-2" onclick="goHome()">
            <div class="bg-blue-600/20 p-2 rounded-lg">
                <i data-lucide="activity" class="text-blue-500 w-5 h-5"></i>
            </div>
            <div>
                <div class="flex items-center gap-1">
                    <h1 class="text-lg font-bold tracking-tight leading-none uppercase">OSTEO<span class="text-blue-500">COACH</span></h1>
                    <span class="text-[9px] text-zinc-500 font-mono border border-zinc-800 px-1 rounded bg-zinc-900/50">v5.1</span>
                </div>
                <p class="text-[9px] text-zinc-500 font-bold tracking-widest uppercase">Clinical Strength</p>
            </div>
        </div>
        <div id="sync-status" class="flex items-center gap-2 text-[10px] font-bold text-zinc-500 bg-zinc-900 px-3 py-1 rounded-full border border-zinc-800">
            <div class="w-1.5 h-1.5 rounded-full bg-zinc-600"></div> SYNCING
        </div>
    </div>

    <div id="main-container" class="mt-20 px-4 max-w-md mx-auto min-h-[80vh]"></div>

    <!-- NAVIGATION -->
    <nav class="nav-bar">
        <button class="nav-item active" onclick="goHome()"><i data-lucide="layout-grid" class="w-6 h-6"></i><span>Hub</span></button>
        <button class="nav-item" onclick="showStats()"><i data-lucide="line-chart" class="w-6 h-6"></i><span>Stats</span></button>
        <button class="nav-item" onclick="showHistory()"><i data-lucide="calendar-days" class="w-6 h-6"></i><span>History</span></button>
        <button class="nav-item" onclick="showSettings()"><i data-lucide="user-cog" class="w-6 h-6"></i><span>Profile</span></button>
    </nav>

    <!-- EXERCISE SWAP MODAL -->
    <div id="swap-modal" class="fixed inset-0 bg-black/90 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6 w-full max-w-sm">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl">Swap Exercise</h3>
                <button onclick="closeSwap()" class="text-zinc-500"><i data-lucide="x"></i></button>
            </div>
            <div id="swap-options" class="space-y-3"></div>
        </div>
    </div>

    <!-- E1RM INFO MODAL -->
    <div id="e1rm-modal" class="fixed inset-0 bg-black/95 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6 w-full max-w-sm relative shadow-2xl">
            <button onclick="document.getElementById('e1rm-modal').classList.add('hidden')" class="absolute top-4 right-4 text-zinc-500 hover:text-white"><i data-lucide="x"></i></button>
            <div class="flex items-center gap-3 mb-4">
                <div class="bg-blue-900/30 p-2 rounded-lg"><i data-lucide="calculator" class="text-blue-400 w-6 h-6"></i></div>
                <h3 class="font-bold text-xl text-white">What is e1RM?</h3>
            </div>
            <p class="text-zinc-400 text-sm mb-4 leading-relaxed">"Estimated 1-Rep Max" is a calculation of the maximum weight you <i>theoretically</i> could lift for one repetition, based on your current set.</p>
            <div class="bg-black/50 border border-zinc-800 p-4 rounded-lg mb-4">
                <code class="text-xs text-blue-400 block mb-1">THE FORMULA</code>
                <code class="text-sm font-mono text-white">Weight × (1 + Reps/30)</code>
            </div>
            <div class="flex gap-3">
                <i data-lucide="shield-check" class="text-green-500 w-5 h-5 flex-shrink-0"></i>
                <p class="text-zinc-300 text-xs leading-relaxed"><b>Why we use it:</b> It allows us to track your strength progress safely without ever asking you to attempt a dangerous, heavy single lift that could hurt your back.</p>
            </div>
        </div>
    </div>

    <script>
        const STEIN_URL = "https://api.steinhq.com/v1/storages/696ecce0affba40a623d7c26/workouts";
        
        // --- MASTER DATA & ALTERNATIVES ---
        const ALTERNATIVES = {
            'Bench Press': ['Dumbbell Bench Press', 'Machine Chest Press', 'Smith Machine Bench'],
            'Chest-Supported Row': ['Machine Row (Plate Loaded)', 'Chest-Supported DB Row', 'Seated Cable Row (Strict)'],
            'Seated Tricep Dip': ['Tricep Cable Pushdown', 'Skullcrushers (Floor)', 'Close Grip Bench'],
            'Lat Pulldown': ['Neutral Grip Pulldown', 'Assisted Pull-Up', 'Straight Arm Pulldown'],
            'Leg Press': ['Hack Squat Machine', 'Belt Squat', 'Goblet Squat (Light)'],
            'Lying Leg Curl': ['Seated Leg Curl', 'RDL (Dumbbell - Strict)', 'Swiss Ball Curl'],
            'Leg Extension': ['Single Leg Extension', 'Step Ups (Low Box)', 'Sissy Squat (Supported)'],
            'Calf Raise': ['Seated Calf Raise', 'Leg Press Calf Raise', 'Standing Calf (Machine)'],
            'Incline DB Press': ['Incline Machine Press', 'Landmine Press', 'Shoulder Press (High Incline)'],
            'Seated Lateral Raise': ['Cable Lateral Raise', 'Machine Lateral Raise', 'Upright Row (Rope)'],
            'Machine Pec Fly': ['Cable Fly', 'Dumbbell Fly (Floor)', 'Pec Deck'],
            'Incline Bicep Curl': ['Cable Curl (Behind)', 'Preacher Curl', 'Hammer Curl']
        };

        // --- STATE ---
        let state = { 
            logs: [], 
            currentWorkoutId: 'A', 
            painLevel: 0, 
            warmupStep: 0,
            userProfile: null, 
            customRoutine: {}
        };

        const BASE_WORKOUTS = {
            'A': { name: 'Upper Power', focus: 'Spinal Stability', exercises: [ {n:'Bench Press', t:'Safe Load'}, {n:'Chest-Supported Row', t:'Anti-Flexion'}, {n:'Seated Tricep Dip', t:'Safe Sub'}, {n:'Lat Pulldown', t:'Traction'} ]},
            'B': { name: 'Lower Power', focus: 'Leg Strength', exercises: [ {n:'Leg Press', t:'Safe Load'}, {n:'Lying Leg Curl', t:'Hips Glued'}, {n:'Leg Extension', t:'2s Isometric'}, {n:'Calf Raise', t:'Volume'} ]},
            'C': { name: 'Upper Hypertrophy', focus: 'Muscle Volume', exercises: [ {n:'Incline DB Press', t:'Spine Supported'}, {n:'Machine Row', t:'Mid-Back'}, {n:'Seated Lateral Raise', t:'Control'}, {n:'Machine Pec Fly', t:'Stable'}, {n:'Incline Bicep Curl', t:'Stretch'} ]},
            'D': { name: 'Lower Hypertrophy', focus: 'Leg Isolation', exercises: [ {n:'Leg Press (Low/Close)', t:'Quads'}, {n:'Single Leg Extension', t:'Unilateral'}, {n:'Lying Leg Curl', t:'Hamstrings'}, {n:'Glute Bridge', t:'Posterior Chain'}, {n:'Dead Bug', t:'Core Brace'} ]}
        };

        const WARMUP_STEPS = [
            { name: "Bird-Dog", duration: 10, cue: "Fist tight. Push heel back. Brace core.", icon: "activity" },
            { name: "Side Plank (L)", duration: 10, cue: "Knees bent. Lift hips high.", icon: "shield" },
            { name: "Side Plank (R)", duration: 10, cue: "Balance sides. Hold strong.", icon: "shield" },
            { name: "McGill Curl-Up", duration: 10, cue: "Hands under back. 1 inch lift only.", icon: "check-circle" }
        ];

        async function init() {
            lucide.createIcons();
            const localUser = localStorage.getItem('pf_user');
            if(localUser) state.userProfile = JSON.parse(localUser);
            
            const localRoutine = localStorage.getItem('pf_routine');
            if(localRoutine) state.customRoutine = JSON.parse(localRoutine);

            await syncData();
            
            if(!state.userProfile) {
                renderOnboarding();
            } else {
                goHome();
            }
        }

        async function syncData() {
            const status = document.getElementById('sync-status');
            try {
                const res = await fetch(STEIN_URL);
                if (!res.ok) throw new Error("API Error");
                const cloudData = await res.json();
                state.logs = Array.isArray(cloudData) ? cloudData.filter(d => d.date) : [];
                localStorage.setItem('pf_backup', JSON.stringify(state.logs));
                status.innerHTML = `<div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div> CONNECTED`;
                status.classList.replace('text-zinc-500', 'text-blue-500');
            } catch (e) {
                const local = localStorage.getItem('pf_backup');
                if(local) state.logs = JSON.parse(local);
                status.innerHTML = `<div class="w-1.5 h-1.5 rounded-full bg-orange-500"></div> OFFLINE`;
            }
            determineNext();
        }

        function determineNext() {
            if(!state.logs.length) return;
            const sorted = [...state.logs].sort((a,b) => new Date(b.date) - new Date(a.date));
            const lastId = sorted[0].workoutId;
            const order = ['A','B','C','D'];
            state.currentWorkoutId = order[(order.indexOf(lastId) + 1) % 4];
        }

        // --- ONBOARDING WIZARD ---
        function renderOnboarding() {
            document.getElementById('main-container').innerHTML = `
                <div class="fade-in pt-10 text-center px-4">
                    <div class="mb-8">
                        <h1 class="text-3xl font-black text-white mb-2">Welcome to OsteoCoach</h1>
                        <p class="text-zinc-400">Let's personalize your spine safety protocols.</p>
                    </div>

                    <div class="card mb-6 text-left">
                        <h3 class="font-bold text-lg mb-4 text-blue-400">What movement aggravates your back the most?</h3>
                        
                        <div class="space-y-3">
                            <button onclick="saveProfile('flexion')" class="w-full p-4 rounded-xl border border-zinc-700 hover:border-blue-500 bg-zinc-900 hover:bg-zinc-800 transition text-left flex items-center gap-4">
                                <div class="bg-blue-900/30 p-2 rounded-lg"><i data-lucide="arrow-down-to-line" class="text-blue-400"></i></div>
                                <div>
                                    <div class="font-bold">Bending Forward</div>
                                    <div class="text-xs text-zinc-500">Putting on socks, tying shoes, sitting (Flexion)</div>
                                </div>
                            </button>

                            <button onclick="saveProfile('extension')" class="w-full p-4 rounded-xl border border-zinc-700 hover:border-orange-500 bg-zinc-900 hover:bg-zinc-800 transition text-left flex items-center gap-4">
                                <div class="bg-orange-900/30 p-2 rounded-lg"><i data-lucide="arrow-up-to-line" class="text-orange-400"></i></div>
                                <div>
                                    <div class="font-bold">Arching Back / Standing</div>
                                    <div class="text-xs text-zinc-500">Walking slowly, reaching overhead (Extension)</div>
                                </div>
                            </button>

                            <button onclick="saveProfile('compression')" class="w-full p-4 rounded-xl border border-zinc-700 hover:border-red-500 bg-zinc-900 hover:bg-zinc-800 transition text-left flex items-center gap-4">
                                <div class="bg-red-900/30 p-2 rounded-lg"><i data-lucide="weight" class="text-red-400"></i></div>
                                <div>
                                    <div class="font-bold">Impact / Loading</div>
                                    <div class="text-xs text-zinc-500">Landing from jumps, heavy carry (Compression)</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
            document.querySelector('.nav-bar').classList.add('hidden'); 
        }

        function saveProfile(trigger) {
            state.userProfile = { trigger: trigger };
            localStorage.setItem('pf_user', JSON.stringify(state.userProfile));
            document.querySelector('.nav-bar').classList.remove('hidden');
            goHome();
        }

        function goHome() {
            setActiveNav(0);
            const wId = state.currentWorkoutId;
            render(`
                <div class="fade-in pt-4">
                    <div class="mb-10 text-center">
                        <h2 class="text-3xl font-bold text-white mb-2">Welcome Back</h2>
                        <p class="text-zinc-500 text-sm">Target Session: <span class="text-blue-400 font-bold uppercase tracking-wide">Workout ${wId}</span></p>
                    </div>

                    <div class="card mb-6 bg-zinc-900 border-blue-900/20">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                            <i data-lucide="shield-check" class="text-blue-500"></i> Spinal Readiness
                        </h3>
                        <div class="grid grid-cols-5 gap-2">
                            ${[1,2,3,4,5,6,7,8,9,10].map(n => `
                                <button onclick="handlePain(${n})" class="h-12 rounded-lg font-bold border ${n<=3 ? 'border-blue-600 bg-blue-900/10' : n<=7 ? 'border-orange-600 bg-orange-900/10' : 'border-red-600 bg-red-900/10'} transition-all active:scale-90">${n}</button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="startWarmup()" class="card flex flex-col items-center justify-center gap-3 hover:bg-zinc-800 transition">
                            <div class="bg-blue-500/10 p-4 rounded-full"><i data-lucide="zap" class="text-blue-400"></i></div>
                            <span class="font-bold text-sm">Warmup</span>
                        </button>
                        <button onclick="showStats()" class="card flex flex-col items-center justify-center gap-3 hover:bg-zinc-800 transition">
                            <div class="bg-purple-500/10 p-4 rounded-full"><i data-lucide="line-chart" class="text-purple-400"></i></div>
                            <span class="font-bold text-sm">Analytics</span>
                        </button>
                    </div>
                </div>
            `);
        }

        function handlePain(level) {
            state.painLevel = level;
            if (level <= 3) renderWorkout(state.currentWorkoutId);
            else if (level <= 7) renderRecovery();
            else renderEmergency();
        }

        function startWarmup() { state.warmupStep = 0; renderWarmupStep(); }

        function renderWarmupStep() {
            const step = WARMUP_STEPS[state.warmupStep];
            if(!step) { goHome(); return; }
            render(`
                <div class="fade-in pt-8 text-center flex flex-col justify-between h-[70vh]">
                    <div>
                        <div class="text-xs font-bold text-blue-500 mb-6 tracking-widest uppercase">${state.warmupStep + 1} / ${WARMUP_STEPS.length}</div>
                        <h2 class="text-3xl font-black mb-2">${step.name}</h2>
                        <p class="text-zinc-400 mb-10 px-6">${step.cue}</p>
                        <div class="timer-circle" id="timer-box"><div id="timer-val">${step.duration}</div></div>
                    </div>
                    <div>
                        <button id="timer-btn" onclick="runTimer(${step.duration})" class="btn btn-primary py-5 text-lg">START TIMER</button>
                        <button onclick="goHome()" class="mt-6 text-zinc-600 font-bold text-xs uppercase tracking-widest">Abort</button>
                    </div>
                </div>
            `);
        }

        function runTimer(sec) {
            const val = document.getElementById('timer-val');
            const box = document.getElementById('timer-box');
            document.getElementById('timer-btn').classList.add('hidden');
            box.classList.add('pulse-ring', 'border-blue-500');
            let left = sec;
            const int = setInterval(() => {
                left--; val.innerText = left;
                if(left <= 0) {
                    clearInterval(int);
                    state.warmupStep++;
                    if(state.warmupStep < WARMUP_STEPS.length) renderWarmupStep();
                    else renderWorkout(state.currentWorkoutId);
                }
            }, 1000);
        }

        // --- WORKOUT ENGINE (DYNAMIC) ---
        function renderWorkout(wId) {
            const baseW = BASE_WORKOUTS[wId];
            let html = `<div class="fade-in pt-4 pb-10"><h2 class="text-3xl font-black mb-6 uppercase tracking-tight">${baseW.name}</h2>`;
            
            baseW.exercises.forEach((baseEx, idx) => {
                const slotKey = `${wId}-${idx}`;
                const exerciseName = state.customRoutine[slotKey] || baseEx.n;
                const tag = getDynamicTag(exerciseName, baseEx.t);

                html += `
                <div class="card mb-4 border-l-4 border-l-blue-500">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="flex items-center gap-2">
                                <h3 class="font-bold text-lg leading-tight">${exerciseName}</h3>
                                <button onclick="openSwap('${wId}', ${idx}, '${exerciseName}')" class="text-zinc-600 hover:text-blue-400 transition"><i data-lucide="refresh-cw" class="w-3 h-3"></i></button>
                            </div>
                            <span class="text-[10px] font-bold text-blue-400 uppercase tracking-tighter">${tag}</span>
                        </div>
                    </div>
                    <div class="flex gap-3 items-end">
                        <div class="flex-1"><label class="text-[9px] font-bold text-zinc-600 block mb-1 uppercase">Weight</label><input type="number" id="w-${idx}" class="input-dark" placeholder="0" oninput="upG(${idx})"></div>
                        <div class="flex-1"><label class="text-[9px] font-bold text-zinc-600 block mb-1 uppercase">Reps</label><input type="number" id="r-${idx}" class="input-dark" placeholder="0" oninput="upG(${idx})"></div>
                        <div class="w-12 text-center"><div class="text-[9px] font-bold text-zinc-600 mb-2 uppercase">e1RM</div><div id="g-${idx}" class="font-mono text-sm text-zinc-400">0</div></div>
                    </div>
                    <button onclick="logSet('${wId}', '${exerciseName}', ${idx}, this)" class="btn btn-secondary mt-4 text-xs font-black uppercase tracking-widest py-3">Log Data Point</button>
                </div>`;
            });
            html += `<button onclick="location.reload()" class="btn btn-primary py-5 mt-6 mb-10 shadow-xl shadow-blue-900/20">COMPLETE SESSION</button></div>`;
            render(html);
        }

        // --- SWAP LOGIC ---
        function openSwap(wId, idx, currentName) {
            let categoryKey = null;
            if (ALTERNATIVES[currentName]) categoryKey = currentName;
            if (!categoryKey) {
                for (const [key, alts] of Object.entries(ALTERNATIVES)) {
                    if (alts.includes(currentName)) { categoryKey = key; break; }
                }
            }
            if (!categoryKey) { alert("No alternatives available for this exercise yet."); return; }

            const options = [categoryKey, ...ALTERNATIVES[categoryKey]];
            const modal = document.getElementById('swap-modal');
            const container = document.getElementById('swap-options');
            
            container.innerHTML = options.map(opt => `
                <button onclick="confirmSwap('${wId}', ${idx}, '${opt}')" class="w-full text-left p-3 rounded-lg ${opt === currentName ? 'bg-blue-600 text-white' : 'bg-zinc-800 text-zinc-300 hover:bg-zinc-700'} font-bold text-sm">
                    ${opt}
                </button>
            `).join('');
            modal.classList.remove('hidden');
        }

        function closeSwap() { document.getElementById('swap-modal').classList.add('hidden'); }

        function confirmSwap(wId, idx, newName) {
            const slotKey = `${wId}-${idx}`;
            state.customRoutine[slotKey] = newName;
            localStorage.setItem('pf_routine', JSON.stringify(state.customRoutine));
            closeSwap();
            renderWorkout(wId); 
        }

        function getDynamicTag(exName, defaultTag) {
            const p = state.userProfile?.trigger;
            if (p === 'flexion') {
                if (exName.includes('Leg Press')) return "STOP BEFORE HIPS CURL";
                if (exName.includes('Row')) return "FLAT BACK - STRICT";
                if (exName.includes('Dead')) return "NEUTRAL SPINE ONLY";
            }
            if (p === 'extension') {
                if (exName.includes('Press') && !exName.includes('Leg')) return "RIBS DOWN - CORE TIGHT";
                if (exName.includes('Extension')) return "NO ARCHING";
            }
            return defaultTag;
        }

        async function logSet(wId, ex, idx, btn) {
            const w = document.getElementById(`w-${idx}`).value;
            const r = document.getElementById(`r-${idx}`).value;
            if(!w || !r) return;
            const ghost = (w * (1 + r/30)).toFixed(1);
            const entry = { date: new Date().toISOString().split('T')[0], workoutId: wId, exercise: ex, weight: w, reps: r, e1rm: ghost };
            btn.innerHTML = `SYNCING...`;
            try {
                const res = await fetch(STEIN_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify([entry]) });
                if(!res.ok) throw new Error("API Rejected");
                btn.innerHTML = `✓ DATA LOGGED`;
                btn.classList.replace('btn-secondary', 'btn-primary');
            } catch(e) { btn.innerHTML = `! FAILED (Check Headers)`; }
        }

        function showSettings() {
            setActiveNav(3);
            render(`
                <div class="fade-in pt-4">
                    <h2 class="text-2xl font-black mb-6 uppercase">User Profile</h2>
                    
                    <div class="card mb-6">
                        <h3 class="font-bold text-xs text-zinc-500 mb-4 uppercase tracking-widest">Back Sensitivity</h3>
                        <div class="flex items-center gap-4 bg-zinc-900 p-4 rounded-xl border border-zinc-800">
                             <div class="bg-blue-900/20 p-3 rounded-full text-blue-500 font-black text-xl">
                                ${state.userProfile?.trigger === 'flexion' ? '<i data-lucide="arrow-down-to-line"></i>' : 
                                  state.userProfile?.trigger === 'extension' ? '<i data-lucide="arrow-up-to-line"></i>' : 
                                  '<i data-lucide="weight"></i>'}
                             </div>
                             <div>
                                <div class="font-bold capitalize text-white">${state.userProfile?.trigger || 'Unknown'} Intolerant</div>
                                <div class="text-xs text-zinc-500">Workouts adjusted automatically.</div>
                             </div>
                        </div>
                        <button onclick="localStorage.removeItem('pf_user'); location.reload()" class="mt-4 text-xs text-red-500 underline">Reset Profile</button>
                    </div>

                    <div class="card mb-6">
                        <h3 class="font-bold text-xs text-zinc-500 mb-4 uppercase tracking-widest">Customizations</h3>
                         <div class="text-sm text-zinc-400 mb-4">
                            You have customized <b>${Object.keys(state.customRoutine).length}</b> exercises.
                         </div>
                         <button onclick="localStorage.removeItem('pf_routine'); location.reload()" class="btn btn-secondary text-xs">Reset All Exercise Swaps</button>
                    </div>
                     <div class="card">
                        <h3 class="font-bold mb-4">Data Management</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="exp()" class="btn btn-secondary text-xs">EXPORT</button>
                            <label class="btn btn-secondary text-xs cursor-pointer">IMPORT<input type="file" class="hidden" accept=".csv" onchange="imp(this)"></label>
                        </div>
                    </div>
                </div>
            `);
        }

        function render(html) { document.getElementById('main-container').innerHTML = html; lucide.createIcons(); }
        function setActiveNav(idx) { document.querySelectorAll('.nav-item').forEach((el, i) => i === idx ? el.classList.add('active') : el.classList.remove('active')); }
        function upG(idx) { const w = document.getElementById(`w-${idx}`).value; const r = document.getElementById(`r-${idx}`).value; const el = document.getElementById(`g-${idx}`); el.innerText = w && r ? (w * (1 + r/30)).toFixed(1) : '0'; }
        function exp() { let c = "date,workoutId,exercise,weight,reps,e1rm\n"; state.logs.forEach(l => { c += `${l.date},${l.workoutId},${l.exercise},${l.weight},${l.reps},${l.e1rm}\n` }); const b = new Blob([c], {type:'text/csv'}); const u = window.URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = 'osteocoach_data.csv'; a.click(); }
        
        async function imp(i) {
            const f = i.files[0];
            const r = new FileReader();
            const label = i.parentElement;
            label.innerHTML = "UPLOADING...";
            label.classList.add('animate-pulse');
            r.onload = async function(e) {
                const text = e.target.result.replace(/\r/g, '');
                const rows = text.split('\n').slice(1);
                const newEntries = [];
                rows.forEach(row => {
                    if(!row.trim()) return;
                    const cols = row.split(',');
                    if (cols.length < 6) return;
                    const [d, wid, ex, w, rep, e1] = cols;
                    if(d && ex) {
                        const isDuplicate = state.logs.some(log => log.date === d.trim() && log.exercise === ex.trim() && log.weight == w.trim() && log.reps == rep.trim());
                        if (!isDuplicate) newEntries.push({ date: d.trim(), workoutId: wid.trim(), exercise: ex.trim(), weight: w.trim(), reps: rep.trim(), e1rm: e1.trim() });
                    }
                });
                if(newEntries.length > 0) {
                    try {
                        const response = await fetch(STEIN_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(newEntries) });
                        if (!response.ok) throw new Error(`Server Error`);
                        alert(`SUCCESS: Uploaded ${newEntries.length} new records.`); location.reload();
                    } catch(err) { alert(`UPLOAD FAILED.`); label.innerHTML = "FAILED"; }
                } else { alert("No new records."); label.innerHTML = "IMPORT"; label.classList.remove('animate-pulse'); }
            };
            r.readAsText(f);
        }

        function showStats() {
            setActiveNav(1);
            const uniqueExercises = [...new Set(state.logs.map(l => l.exercise))].sort();
            let selectedEx = uniqueExercises.find(e => e.includes('Bench')) || uniqueExercises[0] || '';
            
            // Calc Total Volume
            const totalVol = state.logs.reduce((acc, l) => acc + (parseFloat(l.weight) * parseFloat(l.reps)), 0);
            const tons = (totalVol / 1000).toFixed(1);

            render(`
                <div class="fade-in pt-4 pb-20">
                    <h2 class="text-2xl font-black mb-6 uppercase">Analytics Hub</h2>
                    
                    <!-- Exercise Selector -->
                    <div class="card mb-6">
                        <h3 class="font-bold text-xs text-zinc-500 mb-2 uppercase tracking-widest">Movement Trend</h3>
                        <select id="ex-select" onchange="updateChart(this.value)" class="input-dark text-sm w-full font-bold mb-4">${uniqueExercises.map(ex => `<option value="${ex}" ${ex === selectedEx ? 'selected' : ''}>${ex}</option>`).join('')}</select>
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-2" onclick="document.getElementById('e1rm-modal').classList.remove('hidden')">
                                <span class="font-bold text-xs text-zinc-500 uppercase tracking-widest">e1RM Trend</span>
                                <i data-lucide="info" class="w-4 h-4 text-blue-500 cursor-pointer"></i>
                            </div>
                            <span id="best-display" class="text-xs font-mono font-bold text-blue-400"></span>
                        </div>
                        <div class="relative h-48 w-full"><canvas id="c"></canvas></div>
                    </div>

                    <!-- Lifetime Stats -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="card bg-zinc-900 border-zinc-800">
                            <h3 class="font-bold text-[10px] text-zinc-500 uppercase tracking-widest mb-1">Lifetime Load</h3>
                            <div class="text-2xl font-black text-white">${tons} <span class="text-sm font-bold text-blue-500">TONS</span></div>
                        </div>
                        <div class="card bg-zinc-900 border-zinc-800">
                            <h3 class="font-bold text-[10px] text-zinc-500 uppercase tracking-widest mb-1">Sets Logged</h3>
                            <div class="text-2xl font-black text-white">${state.logs.length}</div>
                        </div>
                    </div>

                    <!-- Volume Chart -->
                    <div class="card mb-6">
                        <h3 class="font-bold text-xs text-zinc-500 mb-4 uppercase tracking-widest">Work Capacity (Daily Volume)</h3>
                        <div class="relative h-40 w-full"><canvas id="volChart"></canvas></div>
                    </div>

                    <!-- Balance Donut -->
                    <div class="card mb-6">
                        <h3 class="font-bold text-xs text-zinc-500 mb-4 uppercase tracking-widest">Training Balance</h3>
                        <div class="relative h-48 w-full flex justify-center"><canvas id="donutChart"></canvas></div>
                    </div>

                    <!-- Consistency Streak -->
                    <div class="card">
                        <h3 class="font-bold text-xs text-zinc-500 mb-4 uppercase tracking-widest">Consistency (Last 14 Days)</h3>
                        <div id="streak-viz" class="flex justify-between"></div>
                    </div>
                </div>
            `);

            if (selectedEx) setTimeout(() => updateChart(selectedEx), 100);
            setTimeout(renderVolumeChart, 150);
            setTimeout(renderDonutChart, 200);
            setTimeout(renderStreak, 250);
        }

        window.updateChart = function(exName) {
            const ctx = document.getElementById('c');
            if(!ctx) return;
            const chartStatus = Chart.getChart(ctx);
            if (chartStatus) chartStatus.destroy();
            const exLogs = state.logs.filter(l => l.exercise === exName).sort((a,b) => new Date(a.date) - new Date(b.date));
            if (exLogs.length === 0) return;
            
            const best = Math.max(...exLogs.map(l => parseFloat(l.e1rm)));
            document.getElementById('best-display').innerText = `ALL-TIME BEST: ${best}kg`;

            new Chart(ctx, { type: 'line', data: { labels: exLogs.map(l => l.date.slice(5)), datasets: [{ label: 'e1RM', data: exLogs.map(l => l.e1rm), borderColor: '#3b82f6', tension: 0.3, pointRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#27272a' } }, x: { grid: { display: false } } } } });
        };

        function renderVolumeChart() {
             const ctx = document.getElementById('volChart');
             if(!ctx) return;
             const volByDate = {};
             state.logs.forEach(l => {
                 if(!volByDate[l.date]) volByDate[l.date] = 0;
                 volByDate[l.date] += (parseFloat(l.weight) * parseFloat(l.reps));
             });
             const dates = Object.keys(volByDate).sort();
             const volumes = dates.map(d => volByDate[d]);
             new Chart(ctx, { type: 'bar', data: { labels: dates.map(d => d.slice(5)), datasets: [{ label: 'Vol', data: volumes, backgroundColor: '#3b82f6', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#27272a' } }, x: { grid: { display: false } } } } });
        }

        function renderDonutChart() {
            const ctx = document.getElementById('donutChart');
            if(!ctx) return;
            const counts = { A:0, B:0, C:0, D:0 };
            state.logs.forEach(l => { if(counts[l.workoutId] !== undefined) counts[l.workoutId]++ });
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['A: Power', 'B: Legs', 'C: Hyper', 'D: Iso'],
                    datasets: [{
                        data: [counts.A, counts.B, counts.C, counts.D],
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '70%', plugins: { legend: { position: 'right', labels: { color: '#94a3b8', font: {size: 10} } } } }
            });
        }

        function renderStreak() {
            const container = document.getElementById('streak-viz');
            if(!container) return;
            const today = new Date();
            let html = '';
            
            // Get unique active dates
            const activeDates = new Set(state.logs.map(l => l.date));

            for (let i = 13; i >= 0; i--) {
                const d = new Date();
                d.setDate(today.getDate() - i);
                const iso = d.toISOString().split('T')[0];
                const isActive = activeDates.has(iso);
                const dayLetter = d.toLocaleDateString('en-US', { weekday: 'narrow' });
                
                html += `
                    <div class="flex flex-col items-center gap-1">
                        <div class="w-2 h-2 rounded-full ${isActive ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]' : 'bg-zinc-800'}"></div>
                        <span class="text-[8px] text-zinc-600">${dayLetter}</span>
                    </div>
                `;
            }
            container.innerHTML = html;
        }
        
        function showHistory() { setActiveNav(2); let h = `<div class="fade-in pt-4"><h2 class="text-2xl font-black mb-6 uppercase">History</h2>`; [...state.logs].reverse().forEach(l => { h += `<div class="card mb-2 py-3 px-4 flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded bg-zinc-900 flex items-center justify-center font-bold text-blue-500">${l.workoutId}</div><div><div class="text-[9px] text-zinc-600 font-bold uppercase">${l.date}</div><div class="font-bold text-xs">${l.exercise}</div></div></div><div class="text-right font-mono text-xs font-bold text-blue-400">${l.weight}kg x ${l.reps}</div></div>`; }); render(h + `</div>`); }
        function renderRecovery() { render(`<div class="fade-in pt-10 text-center"><div class="bg-orange-900/20 border border-orange-500 p-8 rounded-2xl mb-8"><i data-lucide="alert-circle" class="w-16 h-16 text-orange-500 mx-auto mb-4"></i><h2 class="text-2xl font-black text-orange-500 uppercase">Recovery Mode</h2><p class="text-xs text-orange-200/50 mt-2 uppercase tracking-widest">Pain Level ${state.painLevel}</p></div><div class="text-left space-y-4"><div class="card border-l-4 border-orange-500"><h3 class="font-bold">Spinal Decompression</h3><p class="text-zinc-500 text-xs">15 min brisk walk + McGill Big 3 only.</p></div></div><button onclick="goHome()" class="mt-8 text-zinc-500 text-xs font-black uppercase underline">Back to Hub</button></div>`); }
        function renderEmergency() { render(`<div class="fade-in pt-10 text-center"><div class="bg-red-900/20 border border-red-500 p-8 rounded-2xl mb-8"><i data-lucide="shield-x" class="w-16 h-16 text-red-500 mx-auto mb-4"></i><h2 class="text-2xl font-black text-red-500 uppercase">Absolute Stop</h2></div><p class="text-zinc-500 px-6">Your spine is in protective guarding. Do not lift. Lie on your stomach immediately.</p><button onclick="goHome()" class="mt-8 text-zinc-500 text-xs font-black uppercase underline">Back to Hub</button></div>`); }

        init();
    </script>
</body>
</html>
